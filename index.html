<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <script>
        L_PREFER_CANVAS = false;
        L_NO_TOUCH = false;
        L_DISABLE_3D = false;
    </script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
    <meta charset=utf-8 />
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
    <style>
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            left: 0;
        }
    </style>
</head>

<body>
    <div class="folium-map" id="map"></div>
    <div style=" position: absolute; top: 14px; z-index: 1000; left: 60px; ">
        <input id="base_url" type="text" style="font-size: 16px;" placeholder="Base Url (default: base.maps.api.here.com)" maxlength="100" size="40"> </div>
    <div style=" position: absolute; top: 44px; z-index: 1000; left: 60px; ">
        <input id="tiletypes" type="text" style="font-size: 16px;" placeholder="Type Tyle (default: maptile)" maxlength="100" size="40"> </div>
    <div style=" position: absolute; top: 74; z-index: 1000; left: 60px; ">
        <input id="scheme" type="text" style="font-size: 16px;" placeholder="Tile Scheme (default: normal.day)" maxlength="100" size="40"> </div>
    <div style=" position: absolute; top: 104px; z-index: 1000; left: 60px; ">
        <input id="poi_cat_mask" type="text" style="font-size: 16px;" placeholder="pois (default: blank)" maxlength="100" size="40"> </div>
    <div style=" position: absolute; top: 134px; z-index: 1000; left: 60px; ">
        <input id="lg" type="text" style="font-size: 16px;" placeholder="lg (default: eng)" maxlength="100" size="40"> </div>
    <div style=" position: absolute; top: 164px; z-index: 1000; left: 60px; ">
        <input id="style" type="text" style="font-size: 16px;" placeholder="style (default: default)" maxlength="100" size="40"> </div>
    <div style=" position: absolute; top: 194px; z-index: 1000; left: 60px; ">
        <input id="ppi" type="text" style="font-size: 16px;" placeholder="ppi (default: 72)" maxlength="100" size="40"> </div>
    <div id="full_url" style=" position: absolute; top: 96%; z-index: 1000; left: 60px; "></div>
    <div id="meta_switch" style=" position: absolute; top: 20px; z-index: 1000; right: 20px; ">
        <button type="button" onclick="toggle_meta_label()">Toggle Meta Label</button>
    </div>
</body>
<script>
    //Taipei
    var default_lat = 25.03678;
    var default_lon = 121.56851;
    var tile_size = 256;
    var map = L.map('map', {
        center: [default_lat, default_lon]
        , zoom: 15
        , maxZoom: 20
        , minZoom: 4
        , layers: []
        , worldCopyJump: false
        , crs: L.CRS.EPSG3857
        , keyboard: true
    });
    var he_appid = 'NXqTq9BXXeEiR4yuXfjj';
    var he_appcode = '3NpseRCnS25FaujWRdthVQ';

    function getURL(URL) {
        return new Promise(function (resolve, reject) {
            var req = new XMLHttpRequest();
            req.open('GET', URL, true);
            req.onload = function () {
                if (req.status === 200) {
                    resolve(req.responseText);
                }
                else {
                    reject(new Error(req.statusText));
                }
            };
            req.onerror = function () {
                reject(new Error(req.statusText));
            };
            req.send();
        });
    }
    var meta_group = L.featureGroup();

    function call_meta(meta_base_url, x, y, z) {
        //console.log(meta_base_url);
        var meta_markers = [];

        function tile_to_lon(x, z) {
            return (x / Math.pow(2, z) * 360 - 180)
        }

        function tile_to_lat(y, z) {
            var n = Math.PI - 2 * Math.PI * y / Math.pow(2, z)
            return (180 / Math.PI * Math.atan(0.5 * (Math.exp(n) - Math.exp(-n))))
        }
        var tile_lat = tile_to_lat(y, z);
        var tile_lon = tile_to_lon(x, z);
        var px_lat = Math.abs((tile_to_lat(y, z) - tile_to_lat(y + 1, z)) / tile_size);
        var px_lon = Math.abs((tile_to_lon(y, z) - tile_to_lon(y + 1, z)) / tile_size);
        getURL(meta_base_url).then(function onFulfilled(result) {
            var r = JSON.parse(result)
                , metadata = r.metadata
                , city_center_labels = metadata['city center labels']
                , labels = metadata['labels']
                , street_labels = metadata['street labels'];
            for (m = 0; m < labels.length; m++) {
                var label = labels[m]
                    , name = label['name']
                    , type = label['type']
                    , bounding_boxes = label['bounding boxes'];
                for (p = 0; p < bounding_boxes.length; p++) {
                    var bbox = bounding_boxes[p]
                        , left = Math.floor(bbox['left'])
                        , top = Math.floor(bbox['top'])
                        , width = Math.floor(bbox['width'])
                        , height = Math.floor(bbox['height'])
                        , left_lon = tile_to_lon(x, z) + left * px_lon
                        , top_lat = tile_to_lat(y, z) - top * px_lat
                        , center_lon = tile_to_lon(x, z) + (left + width / 2) * px_lon
                        , center_lat = tile_to_lat(y, z) - (top + height / 2) * px_lat
                        , right_lon = tile_to_lon(x, z) + (left + width) * px_lon
                        , buttom_lat = tile_to_lat(y, z) - (top + height) * px_lat;
                    var bounds = [[top_lat, left_lon], [buttom_lat, right_lon]];
                    var meta_rec = L.rectangle(bounds, {
                        color: "#ffbb55"
                        , weight: 1
                    });
                    meta_rec.bindPopup('name: ' + name + '<br>type: ' + type);
                    meta_markers.push(meta_rec);
                }
            }
            for (n = 0; n < city_center_labels.length; n++) {
                var city_center_label = city_center_labels[n]
                    , name = city_center_label['name']
                    , text_box = city_center_label['text box']
                    , info = city_center_label['city center info'];
                var left = Math.floor(text_box['left'])
                    , top = Math.floor(text_box['top'])
                    , width = Math.floor(text_box['width'])
                    , height = Math.floor(text_box['height'])
                    , left_lon = tile_to_lon(x, z) + left * px_lon
                    , top_lat = tile_to_lat(y, z) - top * px_lat
                    , center_lon = tile_to_lon(x, z) + (left + width / 2) * px_lon
                    , center_lat = tile_to_lat(y, z) - (top + height / 2) * px_lat
                    , right_lon = tile_to_lon(x, z) + (left + width) * px_lon
                    , buttom_lat = tile_to_lat(y, z) - (top + height) * px_lat;
                var bounds = [[top_lat, left_lon], [buttom_lat, right_lon]];
                var meta_rec = L.rectangle(bounds, {
                    color: "#ffbb55"
                    , weight: 1
                });
                meta_rec.bindPopup('name: ' + name + '<br>info: ' + JSON.stringify(info));
                meta_markers.push(meta_rec);
            }
            for (q = 0; q < street_labels.length; q++) {
                var street_label = street_labels[q]
                    , street_label_name = street_label['name']
                    , street_label_font_size = street_label['font size']
                    , street_label_vertices = street_label['vertices'];
                var polyline_latlngs = [];
                for (r = 0; r < street_label_vertices.length; r++) {
                    var vertice = street_label_vertices[r]
                        , vertice_x = vertice['x']
                        , vertice_y = vertice['y']
                        , x_lon = tile_to_lon(x, z) + vertice_x * px_lon
                        , y_lat = tile_to_lat(y, z) - vertice_y * px_lat;
                    polyline_latlngs.push([y_lat, x_lon]);
                }
                var street_label_polyline = L.polyline(polyline_latlngs, {
                    color: '#ffbb55'
                    , weight: street_label_font_size
                    , opacity: 0.3
                }).bindPopup('name: ' + street_label_name);
                meta_markers.push(street_label_polyline);
            }
        }).then(function () {
            for (o = 0; o < meta_markers.length; o++) {
                meta_markers[o].addTo(meta_group);
            }
        })
    }

    function onSearch(e) {
        var keyCode = null;
        if (e.which) {
            keyCode = e.which;
        }
        else if (e.keyCode) {
            keyCode = e.keyCode;
        }
        if (keyCode == 13) {
            meta_group.clearLayers();
            map.removeLayer(image_layer);
            var lg = document.getElementById('lg').value;
            var poi_mask_value = document.getElementById('poi_cat_mask').value;
            var tile_base_url = compose_url();
            image_layer.setUrl(tile_base_url);
            map.addLayer(image_layer);
        }
    }

    function compose_url() {
        var base_url = document.getElementById('base_url').value;
        if (!base_url) {
            base_url = 'base.maps.cit.api.here.com';
        }
        var tiletypes = document.getElementById('tiletypes').value;
        if (!tiletypes) {
            tiletypes = 'maptile';
        }
        var scheme = document.getElementById('scheme').value;
        if (!scheme) {
            scheme = 'normal.day';
        }
        var style = document.getElementById('style').value;
        if (!style) {
            style = 'default';
        }
        var ppi = document.getElementById('ppi').value;
        if (!ppi) {
            ppi = '72';
        }
        var pois = document.getElementById('poi_cat_mask').value;
        if (!pois) {
            pois = '';
        }
        var lg = document.getElementById('lg').value;
        if (!lg) {
            lg = 'eng';
        }
        var tile_base_url = 'https://{s}.' + base_url + '/maptile/2.1/' + tiletypes + '/newest/' + scheme + '/{z}/{x}/{y}/256/png8?ppi=' + ppi + '&app_id=' + he_appid + '&app_code=' + he_appcode + '&style=' + style + '&pois=' + pois + '&lg=' + lg;
        document.getElementById('full_url').innerHTML = '<mark>' + 'https://{s}.' + base_url + '/maptile/2.1/' + tiletypes + '/newest/' + scheme + '/{z}/{x}/{y}/256/png8?ppi=' + ppi + '&app_id={APP_ID}&app_code={APP_CODE}&style=' + style + '&lg=' + lg + '&pois=' + pois + '</mark>';
        return tile_base_url
    }
    document.getElementById('base_url').addEventListener('keypress', onSearch);
    document.getElementById('tiletypes').addEventListener('keypress', onSearch);
    document.getElementById('scheme').addEventListener('keypress', onSearch);
    document.getElementById('style').addEventListener('keypress', onSearch);
    document.getElementById('ppi').addEventListener('keypress', onSearch);
    document.getElementById('lg').addEventListener('keypress', onSearch);
    document.getElementById('poi_cat_mask').addEventListener('keypress', onSearch);
    var tile_base_url = compose_url();
    var image_layer = L.tileLayer(tile_base_url, {
        "attribution": "HERE"
        , "detectRetina": true
        , "maxZoom": 20
        , "minZoom": 1
        , "noWrap": false
        , "subdomains": ['1', '2', '3', '4']
    }).addTo(map);
    map.on('zoomstart', function (e) {
        meta_group.clearLayers();
    })
    image_layer.on('tileload', function (e) {
        var coords = e.coords
            , x = coords.x
            , y = coords.y
            , z = coords.z
            , url = e
            , meta_url = e.tile.src + '&metadata=metaonly';
        call_meta(meta_url, x, y, z);
    })
    map.addLayer(image_layer);

    function toggle_meta_label() {
        if (!map.hasLayer(meta_group)) {
            map.addLayer(meta_group);
        }
        else {
            map.removeLayer(meta_group);
        }
    }
    L.control.scale({
        position: 'bottomright'
    }).addTo(map);
</script>